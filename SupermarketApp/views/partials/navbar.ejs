<% const currentUser = typeof user === 'undefined' ? null : user; %>
<header class="app-header">
  <div class="nav-shell">
    <a class="brand-logo" href="<%= currentUser && currentUser.role === 'admin' ? '/admin/dashboard' : '/' %>">Tan's Supermarket</a>

    <ul class="nav-list">
      <% if (currentUser && currentUser.role === 'admin') { %>
        <li><a href="/admin/dashboard">Dashboard</a></li>
        <li><a href="/inventory">Inventory</a></li>
        <li><a href="/addProduct">Add Products</a></li>
        <li><a href="/admin/users">Users</a></li>
        <li><a href="/admin/wallets">Wallets</a></li>
        <li><a href="/admin/orders">All Orders</a></li>
        <li>
          <a href="/admin/refunds">
            Refunds
            <% if (typeof pendingRefundCount !== 'undefined' && pendingRefundCount > 0) { %>
              (<%= pendingRefundCount %>)
            <% } %>
          </a>
        </li>
        <li><a href="/admin/transactions">Transactions</a></li>
        <li><a href="/admin/fraud-analysis">Fraud analysis</a></li>
        <li><a href="/profile">Profile</a></li>
      <% } else if (currentUser) { %>
        <li><a href="/">Home</a></li>
        <li><a href="/shopping">Shop</a></li>
        <li><a href="/orders">Orders</a></li>
        <li><a href="/wallet">Wallet</a></li>
        <li><a href="/profile">Profile</a></li>
      <% } else { %>
        <li><a href="/">Home</a></li>
        <li><a href="/shopping">Shop</a></li>
        <li><a href="/orders">Orders</a></li>
      <% } %>
    </ul>

    <div class="nav-cta">
      <% if (currentUser) { %>
        <div class="user-greeting">
          <span class="avatar-circle"><%= currentUser.username ? currentUser.username.charAt(0).toUpperCase() : 'U' %></span>
          <span>
            Hi, <strong><%= currentUser.username || 'User' %></strong>
            <span class="badge-pill"><%= String(currentUser.role || '').trim().toUpperCase() %></span>
          </span>
        </div>
        <% if (currentUser.role !== 'admin') { %>
          <a class="btn btn-secondary cart-btn" href="/cart">
            Cart
            <% if (typeof cartCount !== 'undefined') { %>
              <span class="cart-badge"><%= cartCount %></span>
            <% } %>
          </a>
          <div class="nav-dropdown">
            <button type="button" class="btn btn-secondary notif-btn">
              Account
              <% if (typeof unreadNotifications !== 'undefined' && unreadNotifications > 0) { %>
                <span class="cart-badge"><%= unreadNotifications %></span>
              <% } %>
            </button>
            <div class="nav-dropdown-menu account-menu">
              <div class="account-row">
                <span>Wallet balance</span>
                <span class="chip success">$<%= Number(walletBalance || 0).toFixed(2) %></span>
              </div>
              <a class="account-link" href="/wallet">Manage wallet</a>
              <div class="account-divider"></div>
              <div class="account-title">Notifications</div>
              <% if (!notifications || !notifications.length) { %>
                <div class="notif-empty">No notifications yet.</div>
              <% } else { %>
                <ul class="notif-list">
                  <% notifications.forEach(n => { %>
                    <li class="notif-item <%= (n.status || '').toLowerCase() === 'unread' ? 'unread' : '' %>">
                      <strong><%= n.title %></strong>
                      <div class="subtle-text"><%= n.message %></div>
                      <div class="subtle-text"><%= new Date(n.created_at).toLocaleString() %></div>
                    </li>
                  <% }) %>
                </ul>
                <form action="/notifications/read-all" method="POST" class="m-0 p-2">
                  <button type="submit" class="btn btn-link">Mark all as read</button>
                </form>
              <% } %>
              <a class="account-link" href="/notifications">View all notifications</a>
            </div>
          </div>
        <% } %>
        <a class="btn btn-primary" href="/logout">Logout</a>
      <% } else { %>
        <a class="btn btn-secondary cart-btn" href="/cart">
          Cart
          <% if (typeof cartCount !== 'undefined') { %>
            <span class="cart-badge"><%= cartCount %></span>
          <% } %>
        </a>
        <a class="btn btn-secondary" href="/login">Login</a>
        <a class="btn btn-primary" href="/register">Create Account</a>
      <% } %>
    </div>
  </div>
</header>
