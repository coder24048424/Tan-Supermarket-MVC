<%- include('partials/head', { pageTitle: "Tan's Supermarket | Fresh groceries in minutes", bodyClass: 'page-home' }) %>

<section class="hero home-hero">
  <div class="hero-content">
    <h1>Fresh finds for every kind of day.</h1>
    <p>Seasonal picks, pantry staples, and bold flavors&mdash;curated fast so you can get back to what matters.</p>

    <div class="hero-card hero-card-inline mb-4">
      <% if (!user) { %>
        <h3>Welcome to Tan's Supermarket</h3>
        <p class="subtle-text">Log in to start exploring the market.</p>
        <a class="btn btn-primary mt-2" href="/login">Login</a>
      <% } else { %>
        <h3>Welcome back, <%= user.username %></h3>
        <p class="subtle-text mb-0">Glad to have you back in the aisles.</p>
      <% } %>
    </div>
  </div>
</section>

<section class="glass-panel">
  <div class="d-flex justify-content-between flex-wrap align-items-center mb-3">
    <div>
      <h2 class="section-title">What's new</h2>
      <p class="subtle-text mb-0">Fresh arrivals pulled straight from our shelves.</p>
    </div>
    <% if (newProducts && newProducts.length) { %>
      <a class="btn btn-secondary" href="/shopping">View all</a>
    <% } %>
  </div>

  <% if (!newProducts || !newProducts.length) { %>
    <div class="empty-state">
      <p>No new products yet. Add one to showcase it here.</p>
    </div>
  <% } else { %>
    <div class="card-grid new-arrivals-grid">
      <% newProducts.slice(0,6).forEach(product => { %>
        <div class="product-card">
          <span class="chip">New arrival</span>
          <div class="product-image-wrap">
            <img src="/images/<%= product.image %>" alt="<%= product.productName %>">
          </div>
          <h3><%= product.productName %></h3>
          <% const qtyNew = Number(product.quantity) || 0; %>
          <p class="subtle-text mb-0 stock-line">
            Stock: <strong><%= qtyNew %></strong>
            <% if (qtyNew === 0) { %>
              <span class="stock-pill danger">Out</span>
            <% } else if (qtyNew <= 10) { %>
              <span class="stock-pill warning">Low</span>
            <% } else { %>
              <span class="stock-pill success">In stock</span>
            <% } %>
          </p>
          <form action="/add-to-cart/<%= product.id %>" method="POST" class="product-actions" data-ajax-cart="true">
            <div class="d-flex justify-content-between align-items-center">
              <span class="price-tag">Price: $<%= Number(product.price || 0).toFixed(2) %></span>
            </div>
            <div class="d-flex justify-content-center">
              <div class="qty-stepper" data-max="<%= product.quantity || 1 %>">
                <button type="button" class="btn-icon qty-minus" aria-label="Decrease quantity" <%= qtyNew === 0 ? 'disabled' : '' %>>-</button>
                <input
                  type="number"
                  class="qty-input"
                  name="quantity"
                  value="1"
                  min="1"
                  max="<%= product.quantity || 1 %>"
                  inputmode="numeric"
                  <%= qtyNew === 0 ? 'disabled' : '' %>
                />
                <button type="button" class="btn-icon qty-plus" aria-label="Increase quantity" <%= qtyNew === 0 ? 'disabled' : '' %>>+</button>
              </div>
            </div>
            <button type="submit" class="btn btn-primary w-100" <%= qtyNew === 0 ? 'disabled' : '' %>>Add to cart</button>
            <a class="btn btn-secondary w-100" href="/product/<%= product.id %>">View details</a>
            <% if (user && user.role === 'admin') { %>
              <a class="btn btn-link" href="/updateProduct/<%= product.id %>">Edit</a>
            <% } %>
          </form>
        </div>
      <% }); %>
    </div>
  <% } %>
</section>

<section class="glass-panel">
  <div class="d-flex justify-content-between flex-wrap align-items-center mb-3">
    <div>
      <h2 class="section-title">Best seller</h2>
      <p class="subtle-text mb-0">Straight from Tan's Supermarket sales board.</p>
    </div>
      <% if (bestSeller) { %>
        <a class="btn btn-secondary" href="/product/<%= bestSeller.id %>">View product</a>
      <% } %>
    </div>

    <% if (!bestSeller) { %>
      <div class="empty-state">
        <p>Add products to spotlight a top seller.</p>
      </div>
    <% } else { %>
      <div class="top-seller-hero">
        <div class="top-seller-media">
          <img src="/images/<%= bestSeller.image %>" alt="<%= bestSeller.productName %>">
        </div>
        <div class="top-seller-info">
          <div>
            <span class="chip">Bestseller</span>
            <h3 class="section-title mb-1"><%= bestSeller.productName %></h3>
            <% const bestQty = Number(bestSeller.quantity) || 0; %>
            <p class="subtle-text mb-1">
              Stock: <strong><%= bestQty %></strong>
              <% if (bestQty === 0) { %>
                <span class="stock-pill danger">Out</span>
              <% } else if (bestQty <= 10) { %>
                <span class="stock-pill warning">Low</span>
              <% } else { %>
                <span class="stock-pill success">In stock</span>
              <% } %>
            </p>
            <p class="subtle-text mb-0">Price: $<%= bestSeller.price.toFixed(2) %></p>
          </div>
          <form action="/add-to-cart/<%= bestSeller.id %>" method="POST" class="top-seller-actions" data-ajax-cart="true">
            <div class="qty-stepper" data-max="<%= bestSeller.quantity || 1 %>">
              <button type="button" class="btn-icon qty-minus" aria-label="Decrease quantity">-</button>
              <input
                type="number"
                class="qty-input"
                name="quantity"
                value="1"
                min="1"
                max="<%= bestSeller.quantity || 1 %>"
                inputmode="numeric"
              />
              <button type="button" class="btn-icon qty-plus" aria-label="Increase quantity">+</button>
            </div>
            <div class="d-flex gap-2 w-100">
              <button type="submit" class="btn btn-primary flex-fill">Add to cart</button>
              <a class="btn btn-secondary flex-fill" href="/product/<%= bestSeller.id %>">See details</a>
            </div>
            <% if (user && user.role === 'admin') { %>
              <a class="btn btn-link mt-1" href="/updateProduct/<%= bestSeller.id %>">Edit</a>
            <% } %>
          </form>
        </div>
      </div>
    <% } %>
  </section>

<% if (user && hasPurchaseHistory) { %>
  <section class="glass-panel">
    <div class="d-flex justify-content-between flex-wrap align-items-center mb-3">
      <div>
      <h2 class="section-title">Purchase frequently</h2>
        <p class="subtle-text mb-0">Items you reach for most often, ready to re-add.</p>
      </div>
      <a class="btn btn-secondary" href="/shopping">Browse more</a>
    </div>

    <% 
      const frequent = [];
      if (categories && categories.length) {
        categories.forEach(cat => {
          (cat.items || []).slice(0, 1).forEach(item => frequent.push(item));
        });
      }
      if (!frequent.length && newProducts && newProducts.length) {
        newProducts.slice(0, 4).forEach(item => frequent.push(item));
      }
    %>

    <% if (!frequent.length) { %>
      <div class="empty-state">
        <p>No frequent items yet. Start shopping to build this list.</p>
      </div>
    <% } else { %>
      <div class="card-grid frequent-grid">
        <% frequent.slice(0,6).forEach(product => { %>
          <div class="product-card">
            <% const qty = Number(product.quantity) || 0; %>
            <div class="product-image-wrap">
              <img src="/images/<%= product.image %>" alt="<%= product.productName %>">
            </div>
            <h3 class="mt-2"><%= product.productName %></h3>
            <p class="subtle-text mb-1 stock-line">
              Stock: <strong><%= qty %></strong>
              <% if (qty === 0) { %>
                <span class="stock-pill danger">Out</span>
              <% } else if (qty <= 10) { %>
                <span class="stock-pill warning">Low</span>
              <% } else { %>
                <span class="stock-pill success">In stock</span>
              <% } %>
            </p>
            <form action="/add-to-cart/<%= product.id %>" method="POST" class="product-actions" data-ajax-cart="true">
              <div class="d-flex justify-content-between align-items-center">
                <span class="price-tag">Price: $<%= Number(product.price || 0).toFixed(2) %></span>
              </div>
              <div class="d-flex justify-content-center">
                <div class="qty-stepper" data-max="<%= product.quantity || 1 %>">
                  <button type="button" class="btn-icon qty-minus" aria-label="Decrease quantity" <%= qty === 0 ? 'disabled' : '' %>>-</button>
                  <input
                    type="number"
                    class="qty-input"
                    name="quantity"
                    value="1"
                    min="1"
                    max="<%= product.quantity || 1 %>"
                    inputmode="numeric"
                    <%= qty === 0 ? 'disabled' : '' %>
                  />
                  <button type="button" class="btn-icon qty-plus" aria-label="Increase quantity" <%= qty === 0 ? 'disabled' : '' %>>+</button>
                </div>
              </div>
              <button type="submit" class="btn btn-primary w-100" <%= qty === 0 ? 'disabled' : '' %>>Add to cart</button>
              <a class="btn btn-secondary w-100" href="/product/<%= product.id %>">View details</a>
            </form>
          </div>
        <% }) %>
      </div>
    <% } %>
  </section>
<% } %>

<%- include('partials/footer') %>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.qty-stepper').forEach(stepper => {
      const minus = stepper.querySelector('.qty-minus');
      const plus = stepper.querySelector('.qty-plus');
      const input = stepper.querySelector('.qty-input');
      const max = parseInt(input.getAttribute('max') || '99', 10);
      const min = parseInt(input.getAttribute('min') || '1', 10);

      const clampAndSet = (next) => {
        const clamped = Math.min(Math.max(next, min), max || min);
        input.value = isNaN(clamped) ? min : clamped;
      };

      minus.addEventListener('click', () => {
        clampAndSet(parseInt(input.value || '1', 10) - 1);
      });

      plus.addEventListener('click', () => {
        clampAndSet(parseInt(input.value || '1', 10) + 1);
      });

      input.addEventListener('input', () => {
        clampAndSet(parseInt(input.value || '1', 10));
      });
    });
  });
</script>
