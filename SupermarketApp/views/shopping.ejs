<%- include('partials/head', { pageTitle: "Shop Tan's Supermarket", bodyClass: 'page-shopping' }) %>

<section class="glass-panel">
  <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-3">
    <div>
      <h2 class="section-title mb-1">Build your basket</h2>
      <p class="subtle-text mb-0">Curated cards inspired by the Dribbble design -- elevated imagery, rounded corners, gentle gradients.</p>
    </div>
    <div class="chip">Hi <%= user.username %>, showing <%= stats.filteredCount %> of <%= stats.totalProducts %> products</div>
  </div>

  <% if (errors && errors.length) { %>
    <div class="toast error mb-3">
      <% errors.forEach(message => { %><div><%= message %></div><% }) %>
    </div>
  <% } %>
  <% if (success && success.length) { %>
    <div class="toast success mb-3">
      <% success.forEach(message => { %><div><%= message %></div><% }) %>
    </div>
  <% } %>

  <form class="catalog-toolbar" action="/shopping" method="GET">
    <div class="search-field">
      <input type="text" name="q" placeholder="Search by product name" value="<%= filters.search %>">
    </div>
    <div class="toolbar-selects">
      <select name="category">
        <% filterOptions.category.forEach(option => { %>
          <option value="<%= option.value %>" <%= (filters.category || '') === option.value ? 'selected' : '' %>><%= option.label %></option>
        <% }) %>
      </select>
      <select name="stock">
        <% filterOptions.stock.forEach(option => { %>
          <option value="<%= option.value %>" <%= filters.stock === option.value ? 'selected' : '' %>><%= option.label %></option>
        <% }) %>
      </select>
      <select name="sort">
        <% filterOptions.sort.forEach(option => { %>
          <option value="<%= option.value %>" <%= filters.sort === option.value ? 'selected' : '' %>><%= option.label %></option>
        <% }) %>
      </select>
    </div>
    <div class="toolbar-actions">
      <button type="submit" class="btn btn-primary">Apply</button>
      <% if (filters.hasActive) { %>
        <a class="btn btn-link" href="/shopping">Reset</a>
      <% } %>
    </div>
  </form>

  <% if (filters.category) { %>
    <p class="subtle-text mb-3">Showing products in <strong><%= filters.category %></strong></p>
  <% } %>

  <div class="card-grid">
    <% if (products.length === 0) { %>
      <div class="empty-state w-100">
        <h4>No products match these filters</h4>
        <p>Try a different keyword or reset the filters to view the full catalog.</p>
        <a class="btn btn-secondary mt-2" href="/shopping">Reset filters</a>
      </div>
    <% } %>

    <% products.forEach(product => { %>
      <div class="product-card">
        <img src="/images/<%= product.image %>" alt="<%= product.productName %>">
        <div class="d-flex justify-content-between align-items-center">
          <h3><%= product.productName %></h3>
          <span class="price-tag">$<%= product.price.toFixed(2) %></span>
        </div>
        <p class="subtle-text mb-2">
          Stock: <strong><%= product.quantity %></strong>
          <% if ((product.quantity || 0) <= 10) { %>
            <span class="chip warning ms-2">Low</span>
          <% } %>
        </p>

        <form action="/add-to-cart/<%= product.id %>" method="POST" class="d-flex flex-column gap-2 mt-auto">
          <div class="qty-control">
            <label for="quantity-<%= product.id %>" class="subtle-text m-0">Qty</label>
            <select class="form-select" id="quantity-<%= product.id %>" name="quantity">
              <% for (let q = 1; q <= Math.min(5, product.quantity || 5); q++) { %>
                <option value="<%= q %>"><%= q %></option>
              <% } %>
            </select>
          </div>
          <div class="d-flex gap-2">
            <a class="btn btn-secondary flex-fill" href="/product/<%= product.id %>">View</a>
            <button type="submit" class="btn btn-primary flex-fill">Add to cart</button>
          </div>
        </form>
      </div>
    <% }) %>
  </div>
</section>

<%- include('partials/footer') %>
