<%- include('partials/head', { pageTitle: "Shop Tan's Supermarket", bodyClass: 'page-shopping' }) %>

<section class="glass-panel">
  <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-3">
    <div>
      <h2 class="section-title mb-1">Build your basket</h2>
      <p class="subtle-text mb-0">Add your favorites to the basket and weâ€™ll keep them ready.</p>
    </div>
    <div class="chip">Hi <%= user.username %>, showing <%= stats.filteredCount %> of <%= stats.totalProducts %> products</div>
  </div>

  <% if (errors && errors.length) { %>
    <div class="toast error mb-3">
      <% errors.forEach(message => { %><div><%= message %></div><% }) %>
    </div>
  <% } %>
  <% if (success && success.length) { %>
    <div class="toast success mb-3">
      <% success.forEach(message => { %><div><%= message %></div><% }) %>
    </div>
  <% } %>

  <form class="catalog-toolbar" action="/shopping" method="GET">
    <div class="catalog-toolbar-inner">
      <div class="search-field flex-fill">
        <input type="text" name="q" placeholder="Search by product name" value="<%= filters.search %>">
      </div>
      <div class="toolbar-selects">
        <select name="category">
          <% filterOptions.category.forEach(option => { %>
            <option value="<%= option.value %>" <%= (filters.category || '') === option.value ? 'selected' : '' %>><%= option.label %></option>
          <% }) %>
        </select>
        <select name="stock">
          <% filterOptions.stock.forEach(option => { %>
            <option value="<%= option.value %>" <%= filters.stock === option.value ? 'selected' : '' %>><%= option.label %></option>
          <% }) %>
        </select>
        <select name="sort">
          <% filterOptions.sort.forEach(option => { %>
            <option value="<%= option.value %>" <%= filters.sort === option.value ? 'selected' : '' %>><%= option.label %></option>
          <% }) %>
        </select>
      </div>
      <div class="toolbar-actions ms-auto">
        <button type="submit" class="btn btn-primary">Apply</button>
        <% if (filters.hasActive) { %>
          <a class="btn btn-link" href="/shopping">Reset</a>
        <% } %>
      </div>
    </div>
  </form>

  <% if (filters.category) { %>
    <p class="subtle-text mb-3">Showing products in <strong><%= filters.category %></strong></p>
  <% } %>

  <div class="card-grid">
    <% if (products.length === 0) { %>
      <div class="empty-state w-100">
        <h4>No products match these filters</h4>
        <p>Try a different keyword or reset the filters to view the full catalog.</p>
        <a class="btn btn-secondary mt-2" href="/shopping">Reset filters</a>
      </div>
    <% } %>

    <% products.forEach(product => { %>
      <div class="product-card">
        <img src="/images/<%= product.image %>" alt="<%= product.productName %>">
        <div class="d-flex justify-content-between align-items-center">
          <h3><%= product.productName %></h3>
          <span class="price-tag">$<%= product.price.toFixed(2) %></span>
        </div>
        <p class="subtle-text mb-2">
          <% const qty = Number(product.quantity) || 0; %>
          Stock: <strong><%= qty %></strong>
          <% if (qty === 0) { %>
            <span class="chip danger ms-2">NO STOCK</span>
          <% } else if (qty <= 10) { %>
            <span class="chip warning ms-2">LOW</span>
          <% } else { %>
            <span class="chip success ms-2">IN STOCK</span>
          <% } %>
        </p>

        <form action="/add-to-cart/<%= product.id %>" method="POST" class="d-flex flex-column gap-2 mt-auto">
          <div class="qty-control">
            <label for="quantity-<%= product.id %>" class="subtle-text m-0">Qty</label>
            <div class="qty-stepper" data-max="<%= product.quantity || 1 %>">
              <button type="button" class="btn-icon qty-minus" aria-label="Decrease quantity">-</button>
              <input
                type="number"
                class="qty-input"
                id="quantity-<%= product.id %>"
                name="quantity"
                value="1"
                min="1"
                max="<%= product.quantity || 1 %>"
                inputmode="numeric"
              />
              <button type="button" class="btn-icon qty-plus" aria-label="Increase quantity">+</button>
            </div>
          </div>
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary flex-fill">Add to cart</button>
            <a class="btn btn-secondary flex-fill" href="/product/<%= product.id %>">View</a>
          </div>
        </form>
      </div>
    <% }) %>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.qty-stepper').forEach(stepper => {
      const minus = stepper.querySelector('.qty-minus');
      const plus = stepper.querySelector('.qty-plus');
      const input = stepper.querySelector('.qty-input');
      const max = parseInt(input.getAttribute('max') || '99', 10);
      const min = parseInt(input.getAttribute('min') || '1', 10);

      const clampAndSet = (next) => {
        const clamped = Math.min(Math.max(next, min), max || min);
        input.value = isNaN(clamped) ? min : clamped;
      };

      minus.addEventListener('click', () => {
        clampAndSet(parseInt(input.value || '1', 10) - 1);
      });

      plus.addEventListener('click', () => {
        clampAndSet(parseInt(input.value || '1', 10) + 1);
      });

      input.addEventListener('input', () => {
        clampAndSet(parseInt(input.value || '1', 10));
      });
    });
  });
</script>

<%- include('partials/footer') %>
