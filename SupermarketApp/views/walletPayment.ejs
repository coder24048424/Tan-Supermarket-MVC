<%- include('partials/head', { pageTitle: 'Wallet Payment', bodyClass: 'page-checkout' }) %>

<section class="glass-panel">
  <div class="payment-hero">
    <div>
      <h2 class="section-title mb-1">Top up store credit</h2>
      <p class="subtle-text mb-0">Complete payment to add credit to your wallet.</p>
    </div>
    <a class="btn btn-secondary" href="/wallet">Back to wallet</a>
  </div>

  <div class="payment-layout">
    <div class="payment-panel" id="wallet-payment-panel">
      <div class="panel-heading">
        <h4>Payment options</h4>
        <p class="subtle-text mb-0">Each option opens in a new tab; select store credit to stay here.</p>
        <div class="selected-method" role="status" aria-live="polite">
          <span class="selected-badge" aria-hidden="true">&#10003;</span>
          <span id="wallet-selected-method-label">Store credit</span>
        </div>
      </div>

      <div class="payment-methods">
        <button type="button" class="payment-method-btn store-credit" data-method="store_credit">
          <span class="pm-icon" aria-hidden="true">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
              <rect x="6" y="6" width="12" height="12" rx="6" stroke="currentColor" stroke-width="1.6" fill="none"/>
              <path d="M6 12h12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
              <path d="M9 10h1.5v4H9zM13 10h1.5v4H13z" fill="currentColor"/>
            </svg>
          </span>
          <span class="pm-label">Store credit</span>
        </button>

        <button type="button" class="payment-method-btn paynow" data-method="paynow">
          <span class="pm-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
              <path d="M4 5h6v6H4zM14 3h6v6h-6zM9 11h6v6H9z" fill="currentColor"/>
            </svg>
          </span>
          <span class="pm-label">Stripe (PayNow)</span>
        </button>

        <button type="button" class="payment-method-btn grabpay" data-method="grabpay">
          <span class="pm-icon">
            <svg width="24" height="24" fill="none">
              <rect x="3" y="4" width="18" height="16" rx="4" stroke="currentColor" stroke-width="1.6"/>
              <path d="M9 11h8" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
              <path d="M9 15h6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
            </svg>
          </span>
          <span class="pm-label">Stripe (Grab)</span>
        </button>

        <button type="button" class="payment-method-btn nets" data-method="nets">
          <span class="pm-icon">
            <svg width="24" height="24" fill="none">
              <rect x="2" y="2" width="6" height="6" rx="1.5" fill="currentColor"/>
              <rect x="16" y="2" width="6" height="6" rx="1.5" fill="currentColor"/>
              <rect x="2" y="16" width="6" height="6" rx="1.5" fill="currentColor"/>
              <rect x="9" y="9" width="6" height="6" rx="1.5" fill="currentColor"/>
            </svg>
          </span>
          <span class="pm-label">NETS QR</span>
        </button>

        <button type="button" class="payment-method-btn paypal" data-method="paypal">
          <span class="pm-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
              <rect width="24" height="24" rx="6" fill="#ffc439"/>
              <path d="M9 7H17C18.1 7 19 7.9 19 9V11C19 12.1 18.1 13 17 13H9V7Z" fill="currentColor"/>
            </svg>
          </span>
          <span class="pm-label">PayPal</span>
        </button>

        <button type="button" class="payment-method-btn paypal-card" data-method="paypal-card">
          <span class="pm-icon">
            <svg width="24" height="24" fill="none">
              <rect width="24" height="24" rx="6" fill="#0b2140"/>
              <path d="M8 9h8v6H8z" stroke="#fff" stroke-width="1.5" fill="none"/>
              <path d="M10 11h6" stroke="#fff" stroke-width="1.4" stroke-linecap="round"/>
            </svg>
          </span>
          <span class="pm-label">DEBIT OR CREDIT CARD</span>
        </button>
      </div>

      <div class="summary-card mt-3 nets-qr-panel" id="wallet-nets-qr-panel" hidden>
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="paypal-label m-0">NETS QR code</div>
          <button type="button" class="btn btn-secondary btn-sm" id="wallet-nets-qr-cancel">Cancel</button>
        </div>
        <div id="wallet-nets-qr-status" class="subtle-text mb-2">Click NETS QR to generate a code.</div>
        <div class="d-flex justify-content-center">
          <img id="wallet-nets-qr-image" alt="NETS QR code"/>
        </div>
        <div class="subtle-text">Time remaining: <span id="wallet-nets-qr-timer">0:00</span></div>
        <button type="button" class="btn btn-success btn-sm mt-2" id="wallet-nets-qr-retry" hidden>Retry NETS QR</button>
      </div>

      <div class="store-credit-panel mt-3" id="wallet-store-credit-panel" hidden>
        <div class="store-credit-balance mb-1">
          Balance: $<%= (walletBalance || 0).toFixed(2) %>
        </div>
        <div class="d-flex gap-2">
          <input type="password" class="form-control" id="wallet-store-credit-password" placeholder="Enter password"/>
          <button type="button" class="btn btn-primary" id="wallet-store-credit-submit">Pay with store credit</button>
        </div>
        <div class="subtle-text mt-1">Enter your wallet password to authenticate.</div>
      </div>

      <button type="button" class="btn proceed-btn w-100 mt-3" id="confirm-topup">
        Proceed with selected payment
      </button>
    </div>

    <div class="summary-rail">
      <div class="summary-card summary-highlight">
        <h4>Order summary</h4>
        <div class="summary-row">
          <span>Items</span>
          <span>1</span>
        </div>
        <div class="summary-row">
          <span>Total</span>
          <span class="summary-total">$<%= Number(amount || 0).toFixed(2) %></span>
        </div>
      </div>

      <div class="summary-card table-card">
        <table class="table-modern">
          <thead>
            <tr>
              <th>Product</th>
              <th>Qty</th>
              <th>Price</th>
              <th>Subtotal</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>Wallet top-up</strong></td>
              <td>1</td>
              <td>$<%= Number(amount || 0).toFixed(2) %></td>
              <td>$<%= Number(amount || 0).toFixed(2) %></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>

<script src="https://unpkg.com/event-source-polyfill"></script>
<script>
  const netsPanel = document.getElementById('wallet-nets-qr-panel');
  const netsStatus = document.getElementById('wallet-nets-qr-status');
  const netsImage = document.getElementById('wallet-nets-qr-image');
  const netsTimer = document.getElementById('wallet-nets-qr-timer');
  const netsCancel = document.getElementById('wallet-nets-qr-cancel');
  const netsRetry = document.getElementById('wallet-nets-qr-retry');
  let netsTimerInterval = null;
  let netsEventSource = null;
  let netsRequestInFlight = false;

  const setNetsStatus = (message, isError, showRetry = false) => {
    if (!netsStatus) return;
    netsStatus.textContent = message;
    netsStatus.className = isError ? 'subtle-text text-danger mb-2' : 'subtle-text mb-2';
    if (netsRetry) netsRetry.hidden = !showRetry;
  };

  const clearNetsTimer = () => {
    if (netsTimerInterval) {
      clearInterval(netsTimerInterval);
      netsTimerInterval = null;
    }
  };

  const closeNetsSse = () => {
    if (netsEventSource) {
      netsEventSource.close();
      netsEventSource = null;
    }
  };

  const startNetsSse = (txnRetrievalRef) => {
    if (!txnRetrievalRef || typeof EventSourcePolyfill === 'undefined') return;
    closeNetsSse();
    const url = `/sse/payment-status/${txnRetrievalRef}`;
    netsEventSource = new EventSourcePolyfill(url, { heartbeatTimeout: 150000 });

    netsEventSource.addEventListener('message', (event) => {
      let payload;
      try {
        payload = JSON.parse(event.data);
      } catch (err) {
        return;
      }

      if (payload && payload.success) {
        closeNetsSse();
        window.location.href = `/wallet/nets-qr/success?txn_retrieval_ref=${txnRetrievalRef}`;
      } else if (payload && payload.fail) {
        closeNetsSse();
        setNetsStatus('NETS payment failed. Please try again.', true, true);
      } else if (payload && payload.error) {
        setNetsStatus('NETS status error. Please try again.', true, true);
      }
    });
  };

  const startNetsTimer = (seconds) => {
    clearNetsTimer();
    let remaining = Number(seconds || 0);
    const tick = () => {
      const minutes = Math.floor(remaining / 60);
      const secs = remaining % 60;
      if (netsTimer) {
        netsTimer.textContent = `${minutes}:${secs.toString().padStart(2, '0')}`;
      }
      remaining = Math.max(0, remaining - 1);
      if (remaining <= 0) {
        clearNetsTimer();
        closeNetsSse();
        setNetsStatus('Transaction timed out. Please try again.', true, true);
      }
    };
    tick();
    netsTimerInterval = setInterval(tick, 1000);
  };

  const showNetsPanel = () => {
    if (netsPanel) netsPanel.hidden = false;
  };

  const requestNetsQr = () => {
    if (netsRequestInFlight) return;
    netsRequestInFlight = true;
    showNetsPanel();
    setNetsStatus('Generating NETS QR code...');
    if (netsRetry) netsRetry.hidden = true;

    fetch('/wallet/payment/method', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ method: 'nets' })
    }).then(() => fetch('/wallet/nets-qr/request', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    })).then(res => res.json()).then((data) => {
      if (!data || !data.success) {
        const err = data && (data.errorMsg || data.error || data.responseCode)
          ? (data.errorMsg || data.error || `Code: ${data.responseCode}`)
          : 'Unable to generate NETS QR.';
        setNetsStatus(err, true, true);
        return;
      }

      if (data.qrCodeUrl) {
        if (netsImage) netsImage.src = data.qrCodeUrl;
      } else {
        setNetsStatus('QR data missing from server response.', true, true);
        return;
      }

      startNetsTimer(data.timer || 300);
      startNetsSse(data.txnRetrievalRef);
      setNetsStatus('Scan with your bank simulator app to complete payment.');
    }).catch(() => {
      setNetsStatus('Unable to generate NETS QR. Please try again.', true, true);
    }).finally(() => {
      netsRequestInFlight = false;
    });
  };

  if (netsCancel) {
    netsCancel.addEventListener('click', () => {
      closeNetsSse();
      clearNetsTimer();
      if (netsPanel) netsPanel.hidden = true;
      setNetsStatus('NETS QR cancelled. Choose another payment method.');
      if (netsRetry) netsRetry.hidden = true;
    });
  }

  if (netsRetry) {
    netsRetry.addEventListener('click', requestNetsQr);
  }

  const paymentPanel = document.getElementById('wallet-payment-panel');
  const methodButtons = paymentPanel ? Array.from(paymentPanel.querySelectorAll('.payment-method-btn[data-method]')) : [];
  const selectedLabel = document.getElementById('wallet-selected-method-label');
  const confirmTopup = document.getElementById('confirm-topup');
  const storePanel = document.getElementById('wallet-store-credit-panel');
  const storeInput = document.getElementById('wallet-store-credit-password');
  const storeSubmit = document.getElementById('wallet-store-credit-submit');

  let selectedWalletMethod = '<%= (selectedMethod || 'paynow') %>'.toLowerCase();

  const setWalletMethodOnServer = async (method) => {
    try {
      await fetch('/wallet/payment/method', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ method })
      });
    } catch (err) {
      console.error('setWalletMethod failed', err);
    }
  };

  const highlightMethodButton = (method) => {
    methodButtons.forEach(btn => {
      const btnMethod = (btn.dataset.method || '').toLowerCase();
      btn.classList.toggle('is-selected', btnMethod === method);
    });
  };

  const updateSelectedLabel = (method) => {
    if (!selectedLabel) return;
    const labelMap = {
      paynow: 'PayNow',
      grabpay: 'GrabPay',
      nets: 'NETS QR',
      paypal: 'PayPal',
      'paypal-card': 'PayPal Debit/Credit',
      store_credit: 'Store credit (wallet)'
    };
    selectedLabel.textContent = labelMap[method] || method.toUpperCase();
  };

  methodButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const method = (btn.dataset.method || '').toLowerCase();
      if (!method) return;
      selectedWalletMethod = method;
      highlightMethodButton(method);
      updateSelectedLabel(method);
      if (storePanel) storePanel.hidden = method !== 'store_credit';
      if (netsPanel && method !== 'nets') netsPanel.hidden = true;
      setWalletMethodOnServer(method);
    });
  });

  if (selectedWalletMethod) {
    highlightMethodButton(selectedWalletMethod);
    updateSelectedLabel(selectedWalletMethod);
  }

  const redirectToPayment = (url) => {
    if (!url) return;
    window.location.href = url;
  };

  const startPayPalFlow = () => {
    return fetch('/wallet/paypal/create-order', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    }).then(res => res.json());
  };

  const startStripeFlow = (variant) => {
    return fetch('/wallet/stripe/create-session', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ variant })
    }).then(res => res.json());
  };

  const handleProceed = () => {
    if (!selectedWalletMethod) {
      return alert('Select a payment method first.');
    }
    if (selectedWalletMethod === 'store_credit') {
      if (storePanel) storePanel.hidden = false;
      return;
    }
    if (selectedWalletMethod === 'nets') {
      requestNetsQr();
      return;
    }
    if (selectedWalletMethod === 'paypal') {
      startPayPalFlow().then(data => {
        if (!data || !data.url) throw new Error('Unable to start PayPal checkout.');
        redirectToPayment(data.url);
      }).catch(err => {
        console.error(err);
        alert('Unable to start PayPal checkout.');
      });
      return;
    }
    if (selectedWalletMethod === 'paypal-card') {
      startPayPalFlow().then(data => {
        if (!data || !data.url) throw new Error('Unable to start PayPal checkout.');
        redirectToPayment(data.url);
      }).catch(err => {
        console.error(err);
        alert('Unable to start PayPal checkout.');
      });
      return;
    }
    const variant = selectedWalletMethod === 'paynow' ? 'paynow' : selectedWalletMethod === 'grabpay' ? 'grabpay' : 'stripe';
    startStripeFlow(variant).then(data => {
      if (!data || !data.url) throw new Error('Unable to start checkout.');
      redirectToPayment(data.url);
    }).catch(err => {
      console.error(err);
      alert('Unable to start checkout.');
    });
  };

  confirmTopup?.addEventListener('click', handleProceed);
  storeSubmit?.addEventListener('click', () => {
    const password = storeInput?.value || '';
    if (!password) {
      alert('Password required.');
      storeInput?.focus();
      return;
    }
    fetch('/wallet/pay_with_store_credit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password })
    }).then(res => res.json()).then(data => {
      if (data && data.success && data.orderId) {
        window.location.href = `/wallet/history/${data.orderId}`;
      } else {
        alert(data.error || 'Unable to top up with store credit.');
      }
    }).catch(err => {
      console.error(err);
      alert('Unable to use store credit.');
    });
  });
  storeInput?.addEventListener('keydown', (evt) => {
    if (evt.key === 'Enter') {
      evt.preventDefault();
      storeSubmit.click();
    }
  });
</script>

<%- include('partials/footer') %>
