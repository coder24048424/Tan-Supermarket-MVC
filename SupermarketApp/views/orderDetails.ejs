<%- include('partials/head', { pageTitle: 'Order details', bodyClass: 'page-orders' }) %>

<section class="glass-panel">
  <div class="d-flex justify-content-between flex-wrap align-items-center mb-3">
    <div>
      <h2 class="section-title mb-1">Order #<%= order.id %></h2>
      <p class="subtle-text mb-0">Placed on <%= order.created_at.toLocaleString() %></p>
    </div>
    <div class="d-flex gap-2">
      <% if (!user || user.role !== 'admin') { %>
        <form action="/orders/<%= order.id %>/reorder" method="POST" class="m-0">
          <button type="submit" class="btn btn-primary">Order all again</button>
        </form>
        <a class="btn btn-secondary" href="/orders">Back to orders</a>
      <% } else { %>
        <span class="btn btn-secondary disabled" aria-disabled="true">Back to orders</span>
      <% } %>
    </div>
  </div>

  <% if (errors && errors.length) { %>
    <div class="toast error mb-3">
      <% errors.forEach(msg => { %><div><%= msg %></div><% }) %>
    </div>
  <% } %>
  <% if (success && success.length) { %>
    <div class="toast success mb-3">
      <% success.forEach(msg => { %><div><%= msg %></div><% }) %>
    </div>
  <% } %>

  <div class="split-layout">
    <div class="summary-card">
      <% const hasRefundApproved = Array.isArray(refunds) && refunds.some(r => {
        const s = String(r.status || '').toLowerCase();
        return s === 'approved' || s === 'processed';
      }); %>
      <% const paymentMethod = (order.payment_method || 'unpaid').toLowerCase(); %>
      <% const paymentLabel = paymentMethod === 'paypal' ? 'PayPal' : paymentMethod === 'card' ? 'Card' : paymentMethod === 'paynow' ? 'PayNow' : paymentMethod === 'nets' ? 'NETS QR' : 'Unpaid'; %>
      <h4>Total Paid</h4>
      <p class="summary-total">$<%= order.total.toFixed(2) %></p>
      <div class="summary-row">
        <span>Status</span>
        <% const status = (order.status || 'delivered').toLowerCase(); %>
        <% const statusClass = status === 'pending' ? 'warning' : 'success'; %>
        <span class="status-pill <%= statusClass %>"><%= status === 'pending' ? 'Pending' : 'Delivered' %></span>
      </div>
      <div class="summary-row">
        <span>Payment</span>
        <span class="status-pill"><%= paymentLabel %></span>
      </div>
      <% if (hasRefundApproved) { %>
        <div class="summary-row">
          <span>Refund</span>
          <span class="status-pill danger">Refunded</span>
        </div>
      <% } %>
      <% if (order.shipping_status) { %>
        <div class="summary-row">
          <span>Shipping</span>
          <span class="status-pill"><%= order.shipping_status %></span>
        </div>
      <% } %>
      <div class="summary-row">
        <span>Items</span>
        <span><%= order.items.length %></span>
      </div>
      <% if (user && user.role === 'admin') { %>
        <% if (ownerDeleted) { %>
          <div class="note-card mt-3">
            <strong>Read-only</strong>
            <div class="subtle-text mb-0">This order belongs to a deleted account. Viewing only; updates are disabled.</div>
          </div>
        <% } else { %>
          <form action="/orders/<%= order.id %>/status" method="POST" class="mt-3 d-grid gap-2">
            <label class="form-label" for="status">Order status</label>
            <select class="form-select" id="status" name="status">
              <option value="pending" <%= status === 'pending' ? 'selected' : '' %>>Pending</option>
              <option value="delivered" <%= status === 'delivered' ? 'selected' : '' %>>Delivered</option>
            </select>
            <label class="form-label" for="shipping_status">Shipping status</label>
            <select class="form-select" id="shipping_status" name="shipping_status">
              <option value="processing" <%= (order.shipping_status || '').toLowerCase() === 'processing' ? 'selected' : '' %>>Processing</option>
              <option value="shipped" <%= (order.shipping_status || '').toLowerCase() === 'shipped' ? 'selected' : '' %>>Shipped</option>
              <option value="delivered" <%= (order.shipping_status || '').toLowerCase() === 'delivered' ? 'selected' : '' %>>Delivered</option>
            </select>
            <button type="submit" class="btn btn-primary">Update status</button>
          </form>
        <% } %>
      <% } %>
      <% if (order.notes) { %>
        <% const noteLines = (order.notes || '').split(/\n/).filter(Boolean); %>
        <div class="note-card mt-3 text-start">
          <strong>Customer & delivery</strong>
          <ul class="mb-0 ps-3">
            <% noteLines.forEach(line => { %>
              <li><%= line %></li>
            <% }) %>
          </ul>
        </div>
      <% } %>

      <% /* Admin manual refund removed */ %>
      <% if (user && user.role !== 'admin') { %>
        <% const hasPending = Array.isArray(refunds) && refunds.some(r => (r.status || '').toLowerCase() === 'pending'); %>
        <form action="/orders/<%= order.id %>/refund-request" method="POST" class="mt-3 d-grid gap-2">
          <label class="form-label" for="refundReasonUser">Request a refund (full order amount: $<%= order.total.toFixed(2) %>)</label>
          <textarea class="form-control" id="refundReasonUser" name="reason" rows="2" placeholder="Reason (required)" <%= hasPending ? 'disabled' : '' %> required></textarea>
          <button type="submit" class="btn btn-primary" <%= hasPending ? 'disabled' : '' %>>
            <%= hasPending ? 'Pending refund request' : 'Submit refund request' %>
          </button>
          <% if (hasPending) { %>
            <div class="subtle-text">A refund request is already pending for this order.</div>
          <% } %>
        </form>
      <% } %>
      <% if (user) { %>
        <a class="btn btn-secondary w-100 mt-2" href="/orders/<%= order.id %>/invoice">View invoice</a>
      <% } %>

      <% if (typeof refunds !== 'undefined' && refunds.length) { %>
        <div class="mt-3">
          <strong>Refunds</strong>
          <ul class="mt-2">
            <% refunds.forEach(r => { %>
              <% const rs = (r.status || '').toLowerCase(); %>
              <% const statusClass = rs === 'pending' ? 'warning' : (rs === 'rejected' ? 'danger' : 'success'); %>
              <li class="d-flex align-items-center gap-2">
                <span>Refund #<%= r.id %> - $<%= Number(r.amount || 0).toFixed(2) %></span>
                <span class="status-pill <%= statusClass %>"><%= (r.status || '').toUpperCase() %></span>
                <span><%= r.reason || 'No reason provided' %></span>
              </li>
            <% }) %>
          </ul>
        </div>
      <% } %>
    </div>

    <div class="glass-panel">
      <h5>Items</h5>
      <table class="table-modern mt-3">
        <thead>
          <tr>
            <th>Product</th>
            <th>Price</th>
            <th>Qty</th>
            <th>Subtotal</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <% order.items.forEach(item => { %>
            <tr>
              <td><%= item.productName %></td>
              <td>$<%= item.price.toFixed(2) %></td>
              <td><%= item.quantity %></td>
              <td>$<%= (item.price * item.quantity).toFixed(2) %></td>
              <td>
                <% if (!user || user.role !== 'admin') { %>
                  <form action="/add-to-cart/<%= item.product_id %>" method="POST" class="m-0">
                    <input type="hidden" name="quantity" value="<%= item.quantity %>">
                    <button type="submit" class="btn btn-link">Order again</button>
                  </form>
                <% } %>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>

  <% if (order.notes) { %>
    <% const noteLines = (order.notes || '').split(/\n/).filter(Boolean); %>
    <div class="glass-panel mt-3">
      <h5>Customer details</h5>
      <ul class="mb-0 ps-3">
        <% noteLines.forEach(line => { %>
          <li><%= line %></li>
        <% }) %>
      </ul>
    </div>
  <% } %>
</section>

<%- include('partials/footer') %>
