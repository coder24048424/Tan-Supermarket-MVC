<%- include('partials/head', { pageTitle: 'Order details', bodyClass: 'page-orders' }) %>

<section class="glass-panel">
  <div class="d-flex justify-content-between flex-wrap align-items-center mb-3">
    <div>
      <h2 class="section-title mb-1">Order #<%= order.id %></h2>
      <p class="subtle-text mb-0">Placed on <%= order.created_at.toLocaleString() %></p>
    </div>
    <div class="d-flex gap-2">
      <form action="/orders/<%= order.id %>/reorder" method="POST" class="m-0">
        <button type="submit" class="btn btn-primary">Order all again</button>
      </form>
      <a class="btn btn-secondary" href="/orders">Back to orders</a>
    </div>
  </div>

  <div class="split-layout">
    <div class="summary-card">
      <h4>Total Paid</h4>
      <p class="summary-total">$<%= order.total.toFixed(2) %></p>
      <div class="summary-row">
        <span>Status</span>
        <% const status = (order.status || 'delivered').toLowerCase(); %>
        <% const statusClass = status === 'pending' ? 'warning' : 'success'; %>
        <span class="status-pill <%= statusClass %>"><%= status === 'pending' ? 'Pending' : 'Delivered' %></span>
      </div>
      <% if (order.shipping_status) { %>
        <div class="summary-row">
          <span>Shipping</span>
          <span class="status-pill"><%= order.shipping_status %></span>
        </div>
      <% } %>
      <div class="summary-row">
        <span>Items</span>
        <span><%= order.items.length %></span>
      </div>
      <% if (order.notes) { %>
        <% const noteLines = (order.notes || '').split(/\n/).filter(Boolean); %>
        <div class="note-card mt-3 text-start">
          <strong>Customer & delivery</strong>
          <ul class="mb-0 ps-3">
            <% noteLines.forEach(line => { %>
              <li><%= line %></li>
            <% }) %>
          </ul>
        </div>
      <% } %>

      <% /* Admin manual refund */ %>
      <% if (user && user.role === 'admin') { %>
        <form action="/orders/<%= order.id %>/refund" method="POST" class="mt-3 d-grid gap-2">
          <label class="form-label" for="refundAmount">Refund amount</label>
          <input type="number" step="0.01" min="0" class="form-control" id="refundAmount" name="amount" placeholder="e.g., 5.00" required>
          <textarea class="form-control" name="reason" rows="2" placeholder="Reason (optional)"></textarea>
          <button type="submit" class="btn btn-primary">Create refund</button>
        </form>
      <% } else if (user) { %>
        <% const hasPending = Array.isArray(refunds) && refunds.some(r => (r.status || '').toLowerCase() === 'pending'); %>
        <form action="/orders/<%= order.id %>/refund-request" method="POST" class="mt-3 d-grid gap-2">
          <label class="form-label" for="refundAmountUser">Request a refund</label>
          <input type="number" step="0.01" min="0" class="form-control" id="refundAmountUser" name="amount" placeholder="e.g., 5.00" required <%= hasPending ? 'disabled' : '' %>>
          <textarea class="form-control" name="reason" rows="2" placeholder="Reason (optional)" <%= hasPending ? 'disabled' : '' %>></textarea>
          <button type="submit" class="btn btn-primary" <%= hasPending ? 'disabled' : '' %>>
            <%= hasPending ? 'Pending refund request' : 'Submit refund request' %>
          </button>
          <% if (hasPending) { %>
            <div class="subtle-text">A refund request is already pending for this order.</div>
          <% } %>
        </form>
      <% } %>

      <% if (typeof refunds !== 'undefined' && refunds.length) { %>
        <div class="mt-3">
          <strong>Refunds</strong>
          <ul class="mt-2">
            <% refunds.forEach(r => { %>
              <li>Refund #<%= r.id %> - $<%= Number(r.amount || 0).toFixed(2) %> - <%= (r.status || '').toUpperCase() %> - <%= r.reason || 'No reason provided' %></li>
            <% }) %>
          </ul>
        </div>
      <% } %>
    </div>

    <div class="glass-panel">
      <h5>Items</h5>
      <table class="table-modern mt-3">
        <thead>
          <tr>
            <th>Product</th>
            <th>Price</th>
            <th>Qty</th>
            <th>Subtotal</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <% order.items.forEach(item => { %>
            <tr>
              <td><%= item.productName %></td>
              <td>$<%= item.price.toFixed(2) %></td>
              <td><%= item.quantity %></td>
              <td>$<%= (item.price * item.quantity).toFixed(2) %></td>
              <td>
                <form action="/add-to-cart/<%= item.product_id %>" method="POST" class="m-0">
                  <input type="hidden" name="quantity" value="<%= item.quantity %>">
                  <button type="submit" class="btn btn-link">Order again</button>
                </form>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>

  <% if (order.notes) { %>
    <% const noteLines = (order.notes || '').split(/\n/).filter(Boolean); %>
    <div class="glass-panel mt-3">
      <h5>Customer details</h5>
      <ul class="mb-0 ps-3">
        <% noteLines.forEach(line => { %>
          <li><%= line %></li>
        <% }) %>
      </ul>
    </div>
  <% } %>
</section>

<%- include('partials/footer') %>
