<%- include('partials/head', { pageTitle: 'Product details', bodyClass: 'page-product' }) %>

<section class="glass-panel">
  <% if (!product) { %>
    <div class="empty-state">
      <h4>Product not found</h4>
      <a class="btn btn-secondary mt-2" href="/shopping">Back to shopping</a>
    </div>
  <% } else { %>
    <div class="split-layout align-items-center">
      <div>
        <img src="/images/<%= product.image %>" alt="<%= product.productName %>" style="width:100%;border-radius:30px;object-fit:contain;background:#f7f7f7;padding:0.75rem;">
      </div>
      <div class="d-flex flex-column gap-3">
        <div>
          <h2 class="section-title mb-1"><%= product.productName %></h2>
        </div>
        <div class="glass-panel">
          <div class="summary-row">
            <span>Price</span>
            <span class="price-tag">$<%= product.price.toFixed(2) %></span>
          </div>
          <div class="summary-row">
            <span>Available</span>
            <span><%= product.quantity %> units</span>
          </div>
        </div>
        <% if (user.role === 'admin') { %>
          <div class="d-flex gap-2">
            <a class="btn btn-secondary" href="/inventory">Back to inventory</a>
            <a class="btn btn-primary" href="/updateProduct/<%= product.id %>">Edit product</a>
          </div>
        <% } else { %>
          <div class="d-flex gap-2 align-items-center flex-wrap">
            <a class="btn btn-secondary" href="/shopping">Back to catalog</a>
            <form action="/add-to-cart/<%= product.id %>" method="POST" class="d-flex gap-2 align-items-center">
              <div class="qty-stepper" data-max="<%= product.quantity || 1 %>">
                <button type="button" class="btn-icon qty-minus" aria-label="Decrease quantity">-</button>
                <input
                  type="number"
                  class="qty-input"
                  name="quantity"
                  value="1"
                  min="1"
                  max="<%= product.quantity || 1 %>"
                  inputmode="numeric"
                />
                <button type="button" class="btn-icon qty-plus" aria-label="Increase quantity">+</button>
              </div>
              <button class="btn btn-primary" type="submit">Add to cart</button>
            </form>
          </div>
        <% } %>
      </div>
    </div>
  <% } %>
</section>

<% /* Related products removed for admin edits */ %>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.qty-stepper').forEach(stepper => {
      const minus = stepper.querySelector('.qty-minus');
      const plus = stepper.querySelector('.qty-plus');
      const input = stepper.querySelector('.qty-input');
      const max = parseInt(input.getAttribute('max') || '99', 10);
      const min = parseInt(input.getAttribute('min') || '1', 10);

      const clampAndSet = (next) => {
        const clamped = Math.min(Math.max(next, min), max || min);
        input.value = isNaN(clamped) ? min : clamped;
      };

      minus.addEventListener('click', () => {
        clampAndSet(parseInt(input.value || '1', 10) - 1);
      });

      plus.addEventListener('click', () => {
        clampAndSet(parseInt(input.value || '1', 10) + 1);
      });

      input.addEventListener('input', () => {
        clampAndSet(parseInt(input.value || '1', 10));
      });
    });
  });
</script>

<%- include('partials/footer') %>
