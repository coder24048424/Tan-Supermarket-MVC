<%- include('partials/head', { pageTitle: "Your Tan's Supermarket cart", bodyClass: 'page-cart' }) %>

<section class="glass-panel">
  <% const hasItems = Array.isArray(cart) && cart.length > 0; %>
  <div class="cart-hero">
    <div>
      <h2 class="section-title mb-1">Cart overview</h2>
      <p class="subtle-text mb-0">Cart out soon! While stock last!</p>
    </div>
    <div class="hero-actions">
      <a class="btn btn-secondary" href="/shopping">Continue shopping</a>
      <% if (hasItems) { %>
        <form action="/cart/clear" method="POST" class="m-0">
          <button type="submit" class="btn btn-ghost">Clear cart</button>
        </form>
      <% } %>
    </div>
  </div>

  <% if (errors && errors.length) { %>
    <div class="toast error mb-3">
      <% errors.forEach(message => { %><div><%= message %></div><% }) %>
    </div>
  <% } %>
  <% if (success && success.length) { %>
    <div class="toast success mb-3">
      <% success.forEach(message => { %><div><%= message %></div><% }) %>
    </div>
  <% } %>

  <% if (!hasItems) { %>
    <div class="empty-state">
      <h4>Your cart is empty</h4>
      <p>Discover fresh picks and artisan treats.</p>
      <a class="btn btn-primary mt-2" href="/shopping">Browse Shop</a>
    </div>
  <% } else { %>
    <% let total = 0; %>
    <% cart.forEach(item => { total += item.price * item.quantity; }); %>

    <div class="split-layout">
      <div class="d-flex flex-column gap-3 cart-products">
      <% cart.forEach(item => { %>
        <div class="inventory-card">
            <div class="d-flex gap-3 align-items-center">
              <img src="/images/<%= item.image %>" alt="<%= item.productName %>" style="width:140px;height:140px;object-fit:contain;border-radius:20px;background:#f7f7f7;padding:0.5rem;">
              <div class="flex-grow-1">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <h4 class="mb-1"><%= item.productName %></h4>
                    <form action="/cart/update/<%= item.productId %>" method="POST" class="d-flex align-items-center gap-2 mt-1 qty-form">
                      <input type="hidden" name="delta" value="0">
                      <span class="subtle-text mb-0">Qty:</span>
                      <div class="qty-control">
                        <button type="button" data-delta="-1" class="qty-btn" aria-label="Decrease quantity">-</button>
                        <span class="qty-value"><%= item.quantity %></span>
                        <button type="button" data-delta="1" class="qty-btn" aria-label="Increase quantity">+</button>
                      </div>
                    </form>
                  </div>
                  <span class="price-tag">$<%= (item.price * item.quantity).toFixed(2) %></span>
                </div>
                <div class="d-flex gap-2 mt-2">
                  <a class="btn btn-link text-danger" href="/remove-from-cart/<%= item.productId %>" onclick="return confirm('Remove this item from cart?')">Remove</a>
                  <span class="chip">$<%= item.price.toFixed(2) %> each</span>
                </div>
              </div>
            </div>
          </div>
        <% }) %>
      </div>

      <div class="summary-card cart-summary">
        <h3 class="mb-3">Order summary</h3>
        <div class="summary-row">
          <span>Items</span>
          <span><%= cart.length %></span>
        </div>
        <div class="summary-row">
          <span>Subtotal</span>
          <span>$<%= total.toFixed(2) %></span>
        </div>
        <div class="summary-row">
          <span>Delivery</span>
          <span class="badge-pill">Free</span>
        </div>
        <div class="summary-row summary-total">
          <span>Total</span>
          <span>$<%= total.toFixed(2) %></span>
        </div>
        <a class="btn btn-primary w-100 mt-3" href="/checkout">Go to checkout</a>
      </div>
    </div>
  <% } %>
</section>

<script>
  document.querySelectorAll('.qty-form').forEach((form) => {
    const hiddenDelta = form.querySelector('input[name="delta"]');
    form.querySelectorAll('.qty-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        hiddenDelta.value = btn.getAttribute('data-delta') || '0';
        form.submit();
      });
    });
  });
</script>

<%- include('partials/footer') %>
