<%- include('partials/head', { pageTitle: 'Inventory dashboard', bodyClass: 'page-admin' }) %>

<section class="glass-panel">
  <div class="d-flex justify-content-between flex-wrap gap-2 align-items-end">
    <div>
      <h2 class="section-title mb-1">Inventory overview</h2>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-secondary" href="/addProduct">Add product</a>
      <a class="btn btn-primary" href="/shopping">View Storefront</a>
    </div>
  </div>

  <% if (success && success.length) { %>
    <div class="toast success mt-4">
      <% success.forEach(msg => { %><div><%= msg %></div><% }) %>
    </div>
  <% } %>
  <% if (errors && errors.length) { %>
    <div class="toast error mt-4">
      <% errors.forEach(msg => { %><div><%= msg %></div><% }) %>
    </div>
  <% } %>

  <% if (stats) { %>
    <div class="metric-grid mt-4">
      <div class="metric-card">
        <p class="subtle-text mb-1">Total Product</p>
        <h3><%= stats.totalProducts %></h3>
      </div>
      <div class="metric-card">
        <p class="subtle-text mb-1">Inventory value</p>
        <h3>$<%= stats.inventoryValue.toFixed(2) %></h3>
      </div>
      <div class="metric-card">
        <p class="subtle-text mb-1">Low stock (&le; 10)</p>
        <h3><%= stats.lowStockCount %></h3>
      </div>
      <div class="metric-card">
        <p class="subtle-text mb-1">Out of stock</p>
        <h3><%= stats.outOfStockCount %></h3>
      </div>
    </div>
    <div class="d-flex flex-wrap gap-2 align-items-center mt-3">
      <span class="subtle-text mb-0">Quick filters:</span>
      <a class="btn <%= filters.stock === 'low' ? 'btn-primary' : 'btn-secondary' %>" href="/inventory?stock=low">
        Low stock (<%= stats.lowStockCount %>)
      </a>
      <a class="btn <%= filters.stock === 'out' ? 'btn-primary' : 'btn-secondary' %>" href="/inventory?stock=out">
        Out of stock (<%= stats.outOfStockCount %>)
      </a>
      <% if (filters.stock === 'low' || filters.stock === 'out') { %>
        <a class="btn btn-link" href="/inventory">Clear</a>
      <% } %>
    </div>
  <% } %>

  <form class="catalog-toolbar mt-4" action="/inventory" method="GET">
    <div class="catalog-toolbar-inner">
      <div class="search-field flex-fill">
        <input type="text" name="q" placeholder="Search by product name" value="<%= filters.search %>">
      </div>
      <div class="toolbar-selects">
        <select name="stock">
          <% filterOptions.stock.forEach(option => { %>
            <option value="<%= option.value %>" <%= filters.stock === option.value ? 'selected' : '' %>><%= option.label %></option>
          <% }) %>
        </select>
        <select name="sort">
          <% filterOptions.sort.forEach(option => { %>
            <option value="<%= option.value %>" <%= filters.sort === option.value ? 'selected' : '' %>><%= option.label %></option>
          <% }) %>
        </select>
        <select name="category">
          <% (filterOptions.category || []).forEach(option => { %>
            <option value="<%= option.value %>" <%= filters.category === option.value ? 'selected' : '' %>><%= option.label %></option>
          <% }) %>
        </select>
      </div>
      <div class="toolbar-actions ms-auto">
        <button type="submit" class="btn btn-primary">Apply</button>
        <% if (filters.hasActive) { %>
          <a class="btn btn-link" href="/inventory">Reset</a>
        <% } %>
      </div>
    </div>
  </form>

  <% if (products.length === 0) { %>
    <div class="empty-state">
      <h4>No products found</h4>
      <p>There are no items that match these filters. Reset the search to view all inventory.</p>
      <a class="btn btn-secondary mt-2" href="/inventory">Reset filters</a>
    </div>
  <% } else { %>
    <div class="inventory-grid mt-4">
      <% products.forEach(product => { %>
        <% const stockClass = (product.quantity || 0) === 0 ? 'danger' : ((product.quantity || 0) <= 10 ? 'warning' : 'success'); %>
        <div class="inventory-card">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h4><%= product.productName %></h4>
            </div>
            <span class="chip <%= stockClass %>"><%= product.quantity %> in stock</span>
          </div>
          <img class="inventory-image" src="/images/<%= product.image %>" alt="<%= product.productName %>">
          <div class="d-flex justify-content-between align-items-center mt-2">
            <span class="price-tag">$<%= product.price.toFixed(2) %></span>
            <a href="/product/<%= product.id %>" class="btn btn-link">Details</a>
          </div>
          <div class="inventory-actions">
            <a class="btn btn-secondary" href="/updateProduct/<%= product.id %>">Edit</a>
            <a class="btn btn-primary" href="/deleteProduct/<%= product.id %>" onclick="return confirm('Delete this product?')">Delete</a>
          </div>
        </div>
      <% }) %>
    </div>
  <% } %>
</section>

<%- include('partials/footer') %>
