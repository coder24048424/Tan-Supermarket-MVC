<%- include('partials/head', { pageTitle: 'Edit user', bodyClass: 'page-users' }) %>

<section class="glass-panel">
  <div class="d-flex justify-content-between flex-wrap align-items-center mb-3">
    <div>
      <h2 class="section-title mb-1">Edit user</h2>
      <p class="subtle-text mb-0">Update details, roles, or reset the password.</p>
    </div>
    <a class="btn btn-secondary" href="/admin/users">Back to users</a>
  </div>

  <% if (errors && errors.length) { %>
    <div class="toast error mb-3">
      <% errors.forEach(msg => { %><div><%= msg %></div><% }) %>
    </div>
  <% } %>
  <% if (success && success.length) { %>
    <div class="toast success mb-3">
      <% success.forEach(msg => { %><div><%= msg %></div><% }) %>
    </div>
  <% } %>

  <form action="/admin/users/<%= userProfile.id %>/edit" method="POST" class="d-grid gap-3">
    <div class="row g-2">
      <div class="col-md-6">
        <label class="form-label" for="username">Username</label>
        <input type="text" id="username" name="username" class="form-control" value="<%= userProfile.username %>" required>
      </div>
      <div class="col-md-6">
        <label class="form-label" for="email">Email</label>
        <input type="email" id="email" name="email" class="form-control" value="<%= userProfile.email %>" required>
      </div>
    </div>

    <div class="row g-2">
      <div class="col-md-6">
        <label class="form-label" for="address">Address</label>
        <input type="text" id="address" name="address" class="form-control" value="<%= userProfile.address || '' %>" required>
      </div>
      <div class="col-md-6">
        <label class="form-label" for="contact">Contact</label>
        <input type="text" id="contact" name="contact" class="form-control" value="<%= userProfile.contact || '' %>" required>
      </div>
    </div>

    <div class="row g-2">
      <div class="col-md-6">
        <label class="form-label" for="role">Role</label>
        <select id="role" name="role" class="form-select" required>
          <option value="user" <%= userProfile.role === 'user' ? 'selected' : '' %>>User</option>
          <option value="admin" <%= userProfile.role === 'admin' ? 'selected' : '' %>>Admin</option>
        </select>
      </div>
      <div class="col-md-6">
        <label class="form-label" for="password">New password (optional)</label>
        <div class="password-field">
          <input type="password" id="password" name="password" class="form-control" placeholder="Leave blank to keep" autocomplete="new-password">
          <button type="button" class="password-toggle" data-target="password" aria-label="Toggle password visibility">Show</button>
        </div>
        <div class="password-field mt-2">
          <input type="password" id="confirmPassword" name="confirmPassword" class="form-control" placeholder="Confirm new password" autocomplete="new-password">
          <button type="button" class="password-toggle" data-target="confirmPassword" aria-label="Toggle password visibility">Show</button>
        </div>
        <p class="subtle-text mb-0">Strong password required: 8+ chars with upper, lower, number, special.</p>
      </div>
    </div>

    <div class="d-flex gap-2 flex-wrap align-items-center">
      <button type="submit" class="btn btn-primary">Save changes</button>
      <a class="btn btn-secondary" href="/admin/users">Cancel</a>
    </div>
  </form>
  <form action="/admin/users/<%= userProfile.id %>/delete" method="POST" onsubmit="return confirm('Delete this user? Ensure admins are demoted before deletion.');" class="mt-3">
    <button type="submit" class="btn btn-link">Delete user</button>
  </form>
</section>

<script>
  (() => {
    document.querySelectorAll('.password-toggle').forEach(toggle => {
      const targetId = toggle.getAttribute('data-target');
      const input = document.getElementById(targetId);
      if (!input) return;
      toggle.addEventListener('click', () => {
        const isPassword = input.type === 'password';
        input.type = isPassword ? 'text' : 'password';
        toggle.textContent = isPassword ? 'Hide' : 'Show';
      });
    });
  })();
</script>

<%- include('partials/footer') %>
